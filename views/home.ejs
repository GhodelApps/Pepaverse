<%- include("partials/head", {user: user}) %> 
<link rel="stylesheet" href="/partials-css/nav.css">
<link rel="stylesheet" href="/home.css">
</head>
<body>
  <%-  include('partials/nav', {user: user}); %> 
  <main id="main" class="container-sm p-4 d-sm-flex flex-sm-column justify-content-sm-center align-items-sm-center align-content-sm-center">
    <h2 class="text-uppercase  mb-4" style="margin: 1rem auto;">Home Page</h2>

    <!-- create-post -->
    <div class="create-posts shadow p-3 mb-5 bg-body rounded">
      <div class="card mb-1 shadow p-3 mb-5 bg-body rounded" style="max-width: 530px;">
        <div class="row g-0 ">
          <div style="margin-top: 3%;"  class=" col-sm-2  text-center">
            <div style="display: flex;  align-items: center;">
              <a href="/profile/<%= user._id %> ">
                <img class = "create-post-img img-thumbnail" src = " <%= user.profileUrl %> " class="img-fluid rounded-start" alt="Users profile">
              </a>
              <a class="create-post-name" href=" /profile/<%= user._id %> "> <h5 class="card-title"><%= user.name %></h5> </a>
            </div>
          </div>
          <div class="col-md-0">
            <div class="card-body">
              <form  action="/users/post" method="post">
                <div class="form-floating mb-1">
                  <input required type="text" class="form-control" name="postTextContent">
                  <label for="postTextContent">What is in your mind <%= user.name %> ?</label>
                </div>
                <input style="float: right; margin: 0.4rem auto;" class="me-md-2 btn btn-primary" type="submit" value="Upload">
              </form>
          </div>
        </div>
      </div>
    </div>
    <h3 class="text-uppercase  mb-4" style="margin: 1rem auto;">Feed</h3>
    <section id="feed"  class="container" >
      <div class="posts">
        <% posts.forEach(post => { %>
          <div class="card mb-3 shadow p-3 mb-5 bg-body rounded" style="max-width: 530px;">
            <div class="row g-0 p-0">
                <div class="col-md-3 text-center p-0">
                  <a href="/profile/<%= post.author._id %> ">
                    <img class="post-img img-thumbnail" src="<%= post.author.profileUrl %> " class="img-fluid rounded-start" alt="Users profile">
                  </a>
                </div>
              <div class="col-md-8">
                <div class="card-body">
                  <a class="post-name" href="/profile/<%= post.author._id %> "><h5 class="card-title"><%= post.author.name %> </h5></a>
                  <p class="card-text"><%= post.content %> </p>
                  <p class="card-text"><small class="text-muted"><%= post.createdAt.toDateString() %> </small></p>
                </div>
                <div class="d-flex">
                  <% if (user.likedPosts.includes(post._id)) { %>
                    <p style="color: red;"  class="m-2 p-2 like <%= post._id %>"><i class="fas fa-heart "></i> <span>Liked</span></p>
                  <% }else {%>
                    <p style="color: black;"  class="m-2 p-2 like <%= post._id %>"><i class="far fa-heart "></i> <span>Like</span></p>
                    <%}%>
                  <p class="m-2 p-2 comment"><i class="far fa-comment "></i> <span>Comment</span></p>
                  <p class="m-2 p-2 share"><i class="far fa-share-square"></i> <span>Share</span></p>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </section>
  </main>
  <%- include("partials/footer") %> 
  <script>
    const likeBtnArray = document.querySelectorAll(".like");
    
    likeBtnArray.forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const res = await sendLikeRequest(btn.classList[3]);
        if(res.ok){
          if(res.liked){
            btn.style.color = "red";
            btn.children[0].classList.remove("far");
            btn.children[0].classList.add("fas");
            btn.children[1].textContent = "Liked"
          }else{
            btn.style.color = "black";
            btn.children[0].classList.remove("fas");
            btn.children[0].classList.add("far");
            btn.children[1].textContent = "Like"
          }
        }
      });
    });

    const sendLikeRequest = async (postId) => {
      const res = await fetch("/users/like", {
        method: "post",
        credentials: "include",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({postId: postId}),
      });
      const data = await res.json();
      return await data;
    }
    




  </script>