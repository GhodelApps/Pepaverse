<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>home</title>
    <link rel="stylesheet" href="/home.css" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"
      integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <main id="main">
      <nav id="nav">
        <a href="/"><img class="logo" src="/logo.png" alt="logo" /></a>
        <ul class="nav-links">
          <a href="/profile/<%= user._id.toString() %>"><li>Profile</li></a>
          <a href="auth/logout"><li>Logout</li></a>
        </ul>
      </nav>
      <div class="create-post">
        <form action="/users/post/<%= user._id.toString() %> " method="post">
          <h3 style="text-align: left; margin-bottom: 1rem">Create a post</h3>
          <div class="group">
            <img src="<%= user.profileUrl %> " alt="Users Profile" />
            <textarea
              required
              name="postTextContent"
              id="postTextContent"
              cols="45"
              rows="3"
              placeholder="What is in your mind <%= user.name %> ? "
            ></textarea>
            <input class="post-btn" type="submit" value="Post" />
          </div>
        </form>
      </div>
      <div id="posts">
        <h2>Feed</h2>
        <div class="post-conteiner">
          <% posts.forEach(post => { %>
          <div class="post">
            <div class="information">
              <img
                class="post-profile"
                src="<%= post.authorProfileUrl %> "
                alt="Users profile"
              />
              <div>
                <a href="/profile/<%= post.authorId %>"><%= post.author %></a>
                <p class="createdAt">
                  created at: <%= post.createdAt.toUTCString() %>
                </p>
              </div>
            </div>
            <div class="content"><%= post.content %></div>
            <br />
            <div>Likes: <%= post.likes.length%></div>
            <br />
            <div class="like-container <%= post._id %>">
              <i class="<%= user.likedPosts.includes(post._id) ? "fas red-color": "far black-color" %> fa-heart fa-2x"></i>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
    </main>
    <script>
      const allLikeBtns = document.querySelectorAll(".like-container");
      allLikeBtns.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          let query = btn.classList[1];
          fetch(`/likes/${query}`, {
            credentials: "include",
            method: "POST",
          })
            .then((res) => res.json())
            .then((data) => {
              btn.parentElement.children[3].textContent = "Likes: " + data.n;
              let removefa = "fas";
              let addfa = "far";
              let color = "black";

              if (data.liked) {
                removefa = "far";
                addfa = "fas";
                color = "red";
              }
              btn.children[0].classList.remove(removefa);
              btn.children[0].classList.add(addfa);
              btn.children[0].style.color = color;
            });
        });
      });
    </script>
  </body>
</html>
